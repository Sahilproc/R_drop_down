library(shiny)
library(rpivotTable)
library(dplyr)

# Load data
data(mtcars)

# Define UI
ui <- fluidPage(
  titlePanel("Pivot Table Example"),
  sidebarLayout(
    sidebarPanel(
      selectInput("rows", "Select Rows:", choices = names(mtcars)),
      selectInput("cols", "Select Columns:", choices = names(mtcars)),
      selectInput("vals", "Select Values:", choices = names(mtcars), selected = "mpg"),
      selectInput("agg", "Select Aggregation:", choices = c("Sum", "Average"), selected = "Sum")
    ),
    mainPanel(
      rpivotTableOutput("pivot")
    )
  )
)

# Define server
server <- function(input, output) {
  # Create pivot table
  output$pivot <- renderRpivotTable({
    df <- mtcars %>% 
      group_by_at(vars(input$rows, input$cols)) %>% 
      summarise(Total = sum(!!sym(input$vals))) %>% 
      pivot_wider(names_from = input$cols, values_from = Total, values_fill = 0)
    
    df_percent <- df %>% 
      mutate(Total = rowSums(across(everything()))) %>% 
      mutate(across(everything(), ~ . / Total * 100))
    
    rpivotTable(
      data = as.data.frame(df_percent),
      rows = input$rows,
      cols = input$cols,
      aggregatorName = input$agg,
      vals = names(df)[2:length(names(df))],
      rendererName = "Table"
    )
  })
}

# Run the app
shinyApp(ui, server)
